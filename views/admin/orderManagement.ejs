<!DOCTYPE html>
<html lang="en">
  <%- include('../partials/head.ejs') %>
  <body>
    <style>
      td {
        vertical-align: middle;
      }
    </style>

    <%- include('../partials/adminNavBar.ejs') %>
    <div class="mx-auto" style="width: 90%">
      <div class="d-flex">
        <%- include('../partials/adminSideBar.ejs') %>

            <div id="allOrders">

            </div>
      </div>
    </div>

    <script>

     let navHilight= document.getElementById("orders")
      navHilight.classList.add('active')
      navHilight.classList.remove('link-dark')


      window.addEventListener("load", check);
      function check() {
        let inp = document.getElementById("search").value;
        fetch(`http://127.0.0.1:3000/admin/orders/check/${inp}`, {
          method: "GET",
        })
          .then(function (response) {
            return response.json();
          })
          .then((response) => {
            if (response.length != 0) {
              let orders=''
              response.forEach((element, i) => {
                console.log(element.orders)
                let temp
                element.orderdItems.forEach((val,h)=>{
                  // console.log(val)
                temp += `
                      <tr>
                        <td>${val.name}</td>
                        <td>${val.price}</td>
                        <td>${element.orders[h].quantity}</td>
                        <td>${val.price *element.orders[h].quantity }</td>
                        <td>
                          <img src="/images/${val._id}.jpg" alt="${val.name}"  style="width:50px; height:50px;" /></td>
                        <td>
                          <a
                            onclick="removeOrder('${element._id}','${element.orderdItems[0]._id}')"
                            class="btn btn-danger "
                            >Cancel Order</a
                          >
                        </td>
                      </tr>
                `
                })
                if (element.orders.length != 0){
                orders+=`
              <div class="col-lg-12 grid-margin stretch-card">
              <div class="card">
                <div class="card-body">
                  <h4 class="card-title">Name : ${element.users[0].name}</h4>
                  <table class="table table-striped">
                    <thead>
                      <tr>
                        <th>Product Name</th>
                        <th>Price</th>
                        <th>Quantyty</th>
                        <th>Total Price</th>
                        <th>Image</th>
                      </tr>
                    </thead>
                    <tbody>
                      ${temp}
                    </tbody>
                  </table>
                </div>
              </div>
            </div> 
                `
                }
              });
            document.getElementById("allOrders").innerHTML =orders;
            } else {
            document.getElementById("allOrders").innerHTML =`
            <h3>There is no orders</h3>
            `
            }
          });
      }

      function removeOrder(id,proId) {
        let confimDelete = confirm(`Are you sure want to remove this order`);
        if (confimDelete) {
          fetch(
            `http://127.0.0.1:3000/admin/orders/remove/?orderId=${id}&productId=${proId}`,
            {
              method: "GET",
            }
          ).then(response => response.json())
          .then(response => {console.log(response)})
        }
        check();
      }
    </script>
  </body>
</html>
